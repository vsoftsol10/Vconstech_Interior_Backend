generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  name               String
  email              String              @unique
  password           String
  companyId          String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  role               String
  uploadedFiles      File[]
  materialUsages     MaterialUsage[]
  projectAssignments ProjectAssignment[]
  materialRequests   MaterialRequest[]   // ✅ NEW
  notifications      Notification[]      // ✅ NEW
  company            Company?            @relation(fields: [companyId], references: [id])
}

model Project {
  id                 Int                    @id @default(autoincrement())
  name               String
  description        String?
  companyId          String
  startDate          DateTime?
  endDate            DateTime?
  status             ProjectStatus          @default(ONGOING)
  createdAt          DateTime               @default(now())
  budget             Float?
  clientName         String
  projectId          String                 @unique
  projectType        String
  location           String?
  assignedEngineerId Int?
  contracts          Contract[]
  files              File[]
  finances           FinancialTransaction[]
  materialUsages     MaterialUsage[]
  projectMaterials   ProjectMaterial[]      // ✅ NEW: Materials assigned to project
  materialRequests   MaterialRequest[]      // ✅ NEW: Requests for this project
  company            Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignments        ProjectAssignment[]
  assignedEngineer   Engineer?              @relation(fields: [assignedEngineerId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([projectId])
  @@index([status])
  @@index([assignedEngineerId])
}

model ProjectAssignment {
  id         Int      @id @default(autoincrement())
  projectId  Int
  userId     String
  assignedAt DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// ✅ ENHANCED Material Model
model Material {
  id               Int               @id @default(autoincrement())
  materialId       String            @unique           // MAT001, MAT002, etc.
  name             String
  category         String                              // Paint, Wood, Flooring, etc.
  type             String?                             // Keep for backward compatibility
  unit             String                              // liter, sheet, sq.ft, piece
  defaultRate      Float?                              // Price per unit
  vendor           String?                             // Supplier name
  description      String?                             // Additional details
  companyId        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usages           MaterialUsage[]
  projectMaterials ProjectMaterial[]                   // ✅ NEW
  requests         MaterialRequest[]                   // ✅ NEW

  @@index([companyId])
  @@index([materialId])
  @@index([category])
}

// ✅ NEW: Links materials to projects with quantities
model ProjectMaterial {
  id         Int      @id @default(autoincrement())
  projectId  Int
  materialId Int
  assigned   Float                                     // Total quantity assigned
  used       Float    @default(0)                      // Quantity used
  status     ProjectMaterialStatus @default(ACTIVE)   // Active, Completed, Not Used
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([projectId, materialId])
  @@index([projectId])
  @@index([materialId])
  @@index([status])
}

// ✅ ENHANCED MaterialUsage with remarks
model MaterialUsage {
  id         Int      @id @default(autoincrement())
  materialId Int
  projectId  Int
  userId     String
  quantity   Float
  remarks    String?                                   // ✅ NEW: Usage notes
  date       DateTime @default(now())
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([materialId])
  @@index([userId])
  @@index([date])
}

// ✅ NEW: Material Request System
model MaterialRequest {
  id              Int                  @id @default(autoincrement())
  requestId       String               @unique          // REQ001, REQ002, etc.
  employeeId      String
  name            String                                // Material name
  category        String
  unit            String
  defaultRate     Float
  vendor          String?
  description     String?
  type            MaterialRequestType                   // global, project, project-material
  projectId       Int?                                  // For project-specific
  materialId      Int?                                  // For adding existing material
  quantity        Float?                                // For project-specific
  status          RequestStatus        @default(PENDING)
  requestDate     DateTime             @default(now())
  reviewDate      DateTime?
  approvalNotes   String?
  rejectionReason String?
  reviewedBy      String?                               // Supervisor ID
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  employee        User                 @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  project         Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material        Material?            @relation(fields: [materialId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([status])
  @@index([type])
  @@index([projectId])
  @@index([requestDate])
}

// ✅ NEW: Notification System
model Notification {
  id        Int              @id @default(autoincrement())
  userId    String
  message   String
  type      NotificationType                           // success, error, info
  read      Boolean          @default(false)
  date      DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([date])
}

model Contract {
  id             Int      @id @default(autoincrement())
  projectId      Int
  contractorName String
  details        String?
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime @default(now())
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model FinancialTransaction {
  id          Int             @id @default(autoincrement())
  projectId   Int
  type        TransactionType
  amount      Float
  description String?
  date        DateTime        @default(now())
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([date])
}

model File {
  id         Int      @id @default(autoincrement())
  projectId  Int
  uploadedBy String
  fileUrl    String
  fileName   String?
  uploadedAt DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
}

model Company {
  id        String     @id @default(uuid())
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  materials Material[]
  projects  Project[]
  users     User[]
  engineers Engineer[]

  @@map("companies")
}

model Engineer {
  id             Int       @id @default(autoincrement())
  name           String
  empId          String
  phone          String
  alternatePhone String?
  address        String
  profileImage   String?
  username       String?
  password       String?
  companyId      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects       Project[]

  @@unique([empId, companyId])
  @@unique([username, companyId])
  @@index([companyId])
  @@index([username])
  @@map("engineers")
}

// ✅ NEW Enums
enum ProjectMaterialStatus {
  ACTIVE
  COMPLETED
  NOT_USED
}

enum MaterialRequestType {
  GLOBAL           // New material for all projects
  PROJECT          // New project-specific material
  PROJECT_MATERIAL // Add existing material to project
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SUCCESS
  ERROR
  INFO
  WARNING
}

enum Role {
  Admin
  Site_Engineer
}

enum ProjectStatus {
  PENDING
  ONGOING
  COMPLETED
}

enum TransactionType {
  INCOME
  EXPENSE
  BUDGET
}